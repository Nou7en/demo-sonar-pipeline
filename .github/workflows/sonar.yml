name: Pipeline Visual de Calidad

on:
  push:
    branches:
      - main

jobs:
  # CAJA 1: Construcción e Instalación
  instalacion:
    name:  Construcción
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Instalar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Descargar Librerías
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          echo "Librerías listas."

  # CAJA 2: Pruebas Unitarias
  pruebas:
    name: Tests
    needs: instalacion
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Instalar y Testear
        run: |
          pip install pytest pytest-cov
          pytest --cov=. --cov-report=xml
      - name: Guardar Reporte Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  # CAJA 3: SonarCloud
  # Si falla aquí, se pone ROJO y detiene el despliegue
  sonar:
    name:  SonarCloud Scan
    needs: pruebas
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Descargar Reporte Coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # CAJA 4: Despliegue
  # Si Sonar falla, esta caja se salta (se pone GRIS)
  despliegue:
    name: Despliegue
    needs: sonar
    runs-on: ubuntu-latest
    steps:
      - name: Simular Deploy
        run: |
          echo "Desplegando a producción..."
          sleep 2
          echo "¡Despliegue completado!"

  # CAJA 5: Notificación Inteligente
  # Esta caja SIEMPRE corre, y te dice qué pasó
  notificacion:
    name: Enviar Correo
    needs: [sonar, despliegue]  # Observa a ambos trabajos
    if: always()                # <--- ESTA ES LA CLAVE: Corre siempre
    runs-on: ubuntu-latest
    steps:
      - name: Analizar Estado y Notificar
        env:
          RES_SONAR: ${{ needs.sonar.result }}
          RES_DEPLOY: ${{ needs.despliegue.result }}
        run: |
          echo "---------------------------------------"
          # Lógica para decidir el mensaje del correo
          if [ "$RES_SONAR" == "failure" ]; then
            echo " ALERTA: El código fue rechazado por SonarCloud."
            TITULO="[FALLO] Calidad insuficiente - No se desplegó"
          
          elif [ "$RES_DEPLOY" == "skipped" ]; then
             echo " ALERTA: El despliegue se canceló por errores previos."
             TITULO="[CANCELADO] Despliegue abortado"
          
          elif [ "$RES_DEPLOY" == "success" ]; then
             echo " ÉXITO: Calidad aprobada y código en producción."
             TITULO="[EXITO] Pipeline completado correctamente"
          
          else
             echo " ERROR: Algo inesperado pasó."
             TITULO="[ERROR] Revisar GitHub Actions"
          fi

          echo "---------------------------------------"
          echo "Destinatario: tony.chenzhang@udla.edu.ec"
          echo "Asunto: $TITULO"
          sleep 1
          echo " Correo enviado."